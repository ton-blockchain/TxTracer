import{a as z,d as mt,e as pt}from"./ton-vendor-BfW9jqPK.js";import{a as wt}from"./ton-sandbox-BJJ_Xbr6.js";import{c as lt}from"./Badge-BV7jRVJK.js";import{a as vt,b as bt,c as Tt,d as yt,e as Bt,f as Ct}from"./ton-assembly-CW3W9DLg.js";import{a as _t}from"./index-CGLIbKtS.js";vt();var Z=bt(),J=Tt(),E={},M={},A={},tt;function dt(){if(tt)return A;tt=1,Object.defineProperty(A,"__esModule",{value:!0}),A.wait=s,A.base64ToBigint=n,A.bigintToAddress=d;const t=lt(),e=z();async function s(c){return new Promise(h=>setTimeout(h,c))}function n(c){return BigInt("0x"+t.Buffer.from(c,"base64").toString("hex"))}function d(c){if(c!==void 0)try{return(0,e.beginCell)().storeUint(4,3).storeUint(0,8).storeUint(c,256).asSlice().loadAddress()}catch{return}}return A}var et;function ut(){return et||(et=1,function(t){var e={},s=M&&M.__importDefault||function(o){return o&&o.__esModule?o:{default:o}};Object.defineProperty(t,"__esModule",{value:!0}),t.shardAccountToBase64=t.calculateSentTotal=t.findFinalActions=t.computeFinalData=t.prepareEmulator=t.emulatePreviousTransactions=t.collectUsedLibraries=t.getLibraryByHash=t.computeMinLt=t.getBlockAccount=t.getBlockConfig=t.findAllTransactionsBetween=t.findFullBlockForSeqno=t.findShardBlockForTx=t.findRawTxByHash=t.findBaseTxByHash=void 0,t.createShardAccountFromAPI=S,t.normalizeStateFromAPI=P;const n=z(),d=s(mt()),c=pt(),h=wt(),f=dt(),m=e.TONCENTER_API_KEY??"49efa980ccdcd018fd09d387e63537afd9db4dbb8509d69e7bc2303ca2b2c860",p=e.DTON_API_KEY??"fpYxhGTWfIe3ZEf2s6vvgAGmps_qnNmD",T=2e4,v=async(o,a)=>{const r=(await d.default.get(`https://${o?"testnet.":""}toncenter.com/api/v3/transactions`,{params:{hash:a,limit:1},headers:{"X-API-Key":m}})).data.transactions.at(0);if(r===void 0)return;const u=BigInt(r.lt),g=Buffer.from(r.hash,"base64"),w=n.Address.parseRaw(r.account);return{lt:u,hash:g,address:w}};t.findBaseTxByHash=v;const U=async(o,a)=>{const{lt:l,hash:i,address:r}=a;return b(o).getAccountTransactions(r,l,i)};t.findRawTxByHash=U;const k=async(o,a)=>{const l=a.block,i=BigInt(l.shard),r=i<0?i+BigInt("0x10000000000000000"):i;return(await d.default.get(`https://${o?"testnet.":""}toncenter.com/api/v3/blocks`,{params:{workchain:l.workchain,shard:"0x"+r.toString(16),seqno:l.seqno}})).data.blocks[0]};t.findShardBlockForTx=k;const q=async(o,a)=>b(o).getBlock(a);t.findFullBlockForSeqno=q;const D=async(o,a,l)=>new c.TonClient({endpoint:`https://${o?"testnet.":""}toncenter.com/api/v2/jsonRPC`,timeout:T}).getTransactions(a.address,{inclusive:!0,lt:a.lt.toString(),to_lt:(l-1n).toString(),hash:a.hash.toString("base64"),archival:!0,limit:1e3});t.findAllTransactionsBetween=D;const I=async(o,a)=>{const l=b(o),i=a.shards[0].seqno;return(await l.getConfig(i)).config.cell};t.getBlockConfig=I;const F=async(o,a,l)=>{const i=l.shards[0].seqno,r=b(o);try{const u=await r.getAccount(i-1,a);return S(u.account,a)}catch(u){console.error("Cannot get account from API",u);const g=await R(o,i-1,a);return S(g.data.account,a)}};t.getBlockAccount=F;async function R(o,a,l){const r=`${`https://${o?"sandbox":"mainnet"}-v4.tonhubapi.com`}/block/${a}/${l.toString({urlSafe:!0})}`;return d.default.get(r)}const C=(o,a,l)=>{let i=o.lt;const r=a.toString();for(const u of l.shards)for(const g of u.transactions)g.account===r&&BigInt(g.lt)<i&&(i=BigInt(g.lt));return i};t.computeMinLt=C;const O=async(o,a)=>{await(0,f.wait)(1e3);const l=`https://${o?"testnet.":""}dton.io/${p}/graphql`,i={query:`query fetchAuthor { get_lib(lib_hash: "${a}") }`,variables:{}};try{const r=await d.default.post(l,i,{headers:{"Content-Type":"application/json"}});return n.Cell.fromBase64(r.data.data.get_lib)}catch(r){throw console.error("Error fetching library from dton:",r),r instanceof Error?new Error("Get library on dton's graphql: "+r.message):r}};t.getLibraryByHash=O;const W=async(o,a,l)=>{const i=n.Dictionary.empty(n.Dictionary.Keys.BigUint(256),n.Dictionary.Values.Cell()),r=async B=>{if(B===void 0||B.bits.length!==264)return;const y=B.beginParse(!0);if(y.loadUint(8)!==2)return;const X=y.loadBuffer(32).toString("hex").toUpperCase(),Q=await(0,t.getLibraryByHash)(o,X);return i.set(BigInt(`0x${X}`),Q),Q};let u;const g=a.account?.storage.state;g?.type==="active"&&(u=await r(g.state.code??void 0));const w=l.inMessage?.init;return w&&(u??(u=await r(w.code??void 0))),i.size===0?[void 0,u]:[(0,n.beginCell)().storeDictDirect(i).endCell(),u]};t.collectUsedLibraries=W;function S(o,a){const l=i=>i===void 0?0n:BigInt(i);return{account:{addr:a,storage:{lastTransLt:BigInt(o.last?.lt??0),balance:{coins:BigInt(o.balance.coins)},state:P(o.state)},storageStats:{used:{cells:l(o.storageStat?.used.cells),bits:l(o.storageStat?.used.bits)},lastPaid:o.storageStat?.lastPaid??0,duePayment:typeof o.storageStat?.duePayment=="string"?BigInt(o.storageStat.duePayment):void 0,storageExtra:null}},lastTransactionLt:BigInt(o.last?.lt??0),lastTransactionHash:o.last?.hash===void 0?0n:(0,f.base64ToBigint)(o.last.hash)}}function P(o){return o.type==="uninit"?{type:"uninit"}:o.type==="frozen"?{type:"frozen",stateHash:(0,f.base64ToBigint)(o.stateHash)}:{type:"active",state:{code:o.code===null?void 0:n.Cell.fromBase64(o.code),data:o.data===null?void 0:n.Cell.fromBase64(o.data)}}}const N=async(o,a,l,i)=>{if(a.length===0)return{prevBalance:o,shardAccountBase64:i};for(const r of a){const u=await l(r,i);if(!u.result.success)throw new Error(`Transaction failed for lt: ${r.lt}, logs: ${u.logs}, debugLogs: ${u.debugLogs}`);i=u.result.shardAccount,o=(0,n.loadShardAccount)(n.Cell.fromBase64(i).asSlice()).account?.storage.balance.coins??0n}return{prevBalance:o,shardAccountBase64:i}};t.emulatePreviousTransactions=N;const H=async(o,a,l)=>{const i=await h.Blockchain.create();i.verbosity.print=!1,i.verbosity.vmLogs="vm_logs_verbose";const r=i.executor,u=r instanceof h.Executor?r.getVersion():{commitHash:"",commitDate:""};async function g(w,B){const _=w.inMessage;if(!_)throw new Error("No in_message was found in transaction");return r.runTransaction({config:o,libs:a??null,verbosity:"full_location_stack_verbose",shardAccount:B,message:(0,n.beginCell)().store((0,n.storeMessage)(_)).endCell(),now:w.now,lt:w.lt,randomSeed:l,ignoreChksig:!1,debugEnabled:!0})}return{emulatorVersion:u,emulate:g}};t.prepareEmulator=H;const V=(o,a)=>{const i=(0,n.loadShardAccount)(n.Cell.fromBase64(o.shardAccount).asSlice()).account?.storage.balance.coins??0n,r=(0,n.loadTransaction)(n.Cell.fromBase64(o.transaction).asSlice());if(!r.inMessage)throw new Error("No in_message was found in result tx");const u=r.inMessage.info.src??void 0,g=r.inMessage.info.dest;if(u!==void 0&&!n.Address.isAddress(u))throw new Error(`Invalid src address: ${u.toString()}`);if(!n.Address.isAddress(g))throw new Error(`Invalid dest address: ${g?.toString()}`);const w=r.inMessage.info.type==="internal"?r.inMessage.info.value.coins:void 0,B=(0,t.calculateSentTotal)(r),_=r.totalFees.coins;if(r.description.type!=="generic")throw new Error("TxTracer doesn't support non-generic transaction. Given type: "+r.description.type);const y=r.description.computePhase,K=y.type==="skipped"?"skipped":{success:y.success,exitCode:y.exitCode===0?r.description.actionPhase?.resultCode??0:y.exitCode,vmSteps:y.vmSteps,gasUsed:y.gasUsed,gasFees:y.gasFees};return{sender:u,contract:g,money:{balanceBefore:a,sentTotal:B,totalFees:_,balanceAfter:i},emulatedTx:r,amount:w,computeInfo:K}};t.computeFinalData=V;const L=o=>{const a=o.actions;if(a===null)return{finalActions:[],c5:void 0};const l=n.Cell.fromBase64(a);return{finalActions:(0,n.loadOutList)(l.asSlice()),c5:l}};t.findFinalActions=L;const j=o=>{let a=0n;for(const l of o.outMessages.values())l.info.type==="internal"&&(a+=l.info.value.coins);return a};t.calculateSentTotal=j;const G=o=>(0,n.beginCell)().store((0,n.storeShardAccount)(o)).endCell().toBoc().toString("base64");t.shardAccountToBase64=G;const b=o=>new c.TonClient4({endpoint:`https://${o?"sandbox":"mainnet"}-v4.tonhubapi.com`,timeout:T,requestInterceptor:a=>(a.headers["Content-Type"]="application/json",a)})}(M)),M}var Y={},nt;function Et(){return nt||(nt=1,function(t){Object.defineProperty(t,"__esModule",{value:!0}),t.retraceBaseTx=t.retrace=void 0;const e=ut(),s=lt(),n=z(),d=async(f,m)=>{const p=await(0,e.findBaseTxByHash)(f,m);if(p===void 0)throw new Error("Cannot find transaction info");return(0,t.retraceBaseTx)(f,p)};t.retrace=d;const c=async(f,m)=>{const[p]=await(0,e.findRawTxByHash)(f,m);if(p===void 0)throw new Error("Cannot find transaction info");const T=p.block,v=await(0,e.findShardBlockForTx)(f,p);if(v===void 0)throw new Error("Cannot find shard block for transaction");if(v.root_hash!==T.rootHash)throw new Error(`root_hash mismatch in mc_seqno getter: ${T.rootHash} != ${v.root_hash}`);const U=v.masterchain_block_ref.seqno,k=s.Buffer.from(v.rand_seed,"base64"),q=await(0,e.findFullBlockForSeqno)(f,U),D=(0,e.computeMinLt)(p.tx,m.address,q),[I,...F]=await(0,e.findAllTransactionsBetween)(f,m,D);F.reverse();const R=await(0,e.getBlockConfig)(f,q),C=await(0,e.getBlockAccount)(f,m.address,q),[O,W]=await(0,e.collectUsedLibraries)(f,C,p.tx),S=C.account?.storage.state,P=S?.type==="active"?S.state.code??void 0:p.tx.inMessage?.init?.code??void 0,{emulatorVersion:N,emulate:H}=await(0,e.prepareEmulator)(R,O,k);C.lastTransactionLt=0n,C.lastTransactionHash=0n;const V=(0,e.shardAccountToBase64)(C),L=C.account?.storage.balance.coins??0n,{prevBalance:j,shardAccountBase64:G}=await(0,e.emulatePreviousTransactions)(L,F,H,V),b=await H(I,G);if(!b.result.success)throw new Error(`Transaction failed: ${b.result.error}`);const{finalActions:o,c5:a}=(0,e.findFinalActions)(b.result),{sender:l,contract:i,amount:r,money:u,emulatedTx:g,computeInfo:w}=(0,e.computeFinalData)(b.result,j),B=g.stateUpdate.newHash.equals(I.stateUpdate.newHash),_=h(I);return{stateUpdateHashOk:B,codeCell:W??P,originalCodeCell:P,inMsg:{sender:l,contract:i,amount:r,opcode:_},money:u,emulatedTx:{raw:(0,n.beginCell)().store((0,n.storeTransaction)(I)).endCell().toBoc().toString("hex"),utime:g.now,lt:g.lt,computeInfo:w,executorLogs:b.logs,actions:o,c5:a,vmLogs:b.result.vmLog},emulatorVersion:N}};t.retraceBaseTx=c;function h(f){const m=f.inMessage,p=m?.info.type==="internal"?m.info.bounced:!1;let T;const v=m?.body.asSlice();return v&&(p&&v.loadUint(32),v.remainingBits>=32&&(T=v.loadUint(32))),T}}(Y)),Y}var ot;function It(){return ot||(ot=1,function(t){var e=E&&E.__createBinding||(Object.create?function(n,d,c,h){h===void 0&&(h=c);var f=Object.getOwnPropertyDescriptor(d,c);(!f||("get"in f?!d.__esModule:f.writable||f.configurable))&&(f={enumerable:!0,get:function(){return d[c]}}),Object.defineProperty(n,h,f)}:function(n,d,c,h){h===void 0&&(h=c),n[h]=d[c]}),s=E&&E.__exportStar||function(n,d){for(var c in n)c!=="default"&&!Object.prototype.hasOwnProperty.call(d,c)&&e(d,n,c)};Object.defineProperty(t,"__esModule",{value:!0}),s(ut(),t),s(Et(),t),s(dt(),t)}(E)),E}var st=It(),St=yt(),ft=Bt(),At=Ct();const rt=(t,e)=>({$:"BaseInfo",info:t,testnet:e}),x=(t,e)=>({$:"SingleHash",hash:t.toLowerCase(),testnet:e});function xt(t){if(t.startsWith("https://ton.cx/tx/")||t.startsWith("https://testnet.ton.cx/tx/")){const e=t.includes("testnet."),s=e?t.slice(26):t.slice(18),[n,d,c]=s.split(":");return rt(at(n,d,c),e)}if(t.startsWith("https://tonviewer.com/")||t.startsWith("https://testnet.tonviewer.com/")){const e=t.includes("testnet."),s=e?t.slice(42):t.slice(34);return x(s,e)}if(t.startsWith("https://tonscan.org/tx/")||t.startsWith("https://testnet.tonscan.org/tx/")){const e=t.includes("testnet."),s=e?t.slice(31):t.slice(23);if(s.endsWith("=")){const n=Buffer.from(s,"base64");return x(n.toString("hex"),e)}return x(s,e)}if(t.startsWith("https://explorer.toncoin.org/transaction")||t.startsWith("https://test-explorer.toncoin.org/transaction")){const e=t.includes("test-"),s=new URL(t),n=s.searchParams.get("lt")??void 0,d=s.searchParams.get("hash")??void 0,c=s.searchParams.get("account")??void 0;return rt(at(n,d,c),e)}if(t.startsWith("https://dton.io/tx")||t.startsWith("https://testnet.dton.io/tx")){const e=t.includes("testnet."),s=e?t.slice(27):t.slice(19);return x(s,e)}}function at(t,e,s){if(t===void 0||e===void 0||s===void 0)throw new Error("Invalid ton.cx link");const n=e.endsWith("=")?Buffer.from(e,"base64"):Buffer.from(e,"hex");return{lt:BigInt(t),hash:n,address:_t.Address.parse(s)}}class $ extends Error{constructor(e,s){super(e),this.cause=s,this.name="TxTraceError"}}class qt extends ${constructor(e="Transaction not found",s){super(e,s),this.name="TxNotFoundError"}}class Pt extends ${constructor(e="Transaction hash is not valid",s){super(e,s),this.name="TxHashInvalidError"}}class Mt extends ${constructor(e="Network error",s){super(e,s),this.name="NetworkError"}}class $t extends ${constructor(e="Too many requests, please try again a bit later",s){super(e,s),this.name="TooManyRequests"}}async function it(t){if(t.$==="BaseInfo")return st.retraceBaseTx(t.testnet,t.info);if(t.$==="SingleHash")return st.retrace(t.testnet,t.hash);throw new Error("Invalid extraction result")}async function Ft(t){const e=xt(t);if(e===void 0&&t.startsWith("https://"))throw new Error("Unsupported link format: "+t);try{return await ct(500),{result:await it(e??x(t,!1)),network:e?.testnet?"testnet":"mainnet"}}catch(s){if(s instanceof Error&&s.message.includes("Cannot find transaction info"))return console.log("Cannot find in mainnet, trying to find in testnet"),await ct(500),{result:await it(e??x(t,!0)),network:"testnet"};throw s}}async function Ht(t){try{return await Ft(t)}catch(e){let s="An unknown error occurred.";throw e instanceof Error?s=e.message:e!=null&&(s=String(e)),/status code 429/i.test(s)?new $t(void 0,e):/status code 422/i.test(s)?new Pt(void 0,e):/not found/i.test(s)?new qt(void 0,e):/network|fetch|timeout/i.test(s)?new Mt(void 0,e):new $(s,e)}}function Ut(t){const e=t.map(n=>{if(n.$==="VmExceptionHandler")return{text:"",num:n.errno};if(n.$==="VmException")return{text:n.message,num:n.errno};if(n.$==="VmUnknown"&&n.text.includes("unhandled out-of-gas exception"))return{text:n.text,num:-14}}),s=e.find(n=>(n?.text?.length??0)>0);return s||e.find(n=>n!==void 0)}function kt(t,e){const n=[...At.parse(t)].reverse(),d=Ut(n);if(d===void 0)return;const c=n.find(T=>T.$==="VmLoc"),h=ft.findInstructionInfo(e,{hash:c?.hash?.toLowerCase()??"",offset:c?.offset??0,stack:[],gas:0,gasCost:0,implicit:!1});if(h===void 0)return;const[f,m]=h;return{info:f[m],description:d.text,num:d.num}}function ht(t,e){if(!t)return{code:"// No executable code found",traceInfo:{steps:[]}};const s=Z.decompileCell(t),n=J.print(s),d=J.parse("out.tasm",n);if(d.$==="ParseFailure")return{code:n,traceInfo:{steps:[]},exitCode:void 0};const[,c]=Z.compileCellWithMapping(d.instructions),h=St.createMappingInfo(c),f=ft.createTraceInfoPerTransaction(e,h,void 0)[0],m=kt(e,h);return m===void 0?{code:n,exitCode:void 0,traceInfo:f}:{code:n,exitCode:m,traceInfo:f}}function Vt(t,e){if(t.computeInfo==="skipped")return;const n=t.fields.vmLogs;if(!n)return;const c=e.get(t.address?.toString()??"")?.stateInit?.code;if(c)return ht(c,n)}async function Lt(t){const{result:e,network:s}=await Ht(t),{code:n,traceInfo:d,exitCode:c}=ht(e.codeCell,e.emulatedTx.vmLogs);return{result:e,code:n,trace:d,exitCode:c,network:s}}function jt(t){return t.gasCost>5e3?26:t.gasCost}async function ct(t){return new Promise(e=>setTimeout(e,t))}export{J as a,Vt as b,kt as f,Z as i,St as m,jt as n,Lt as t};
